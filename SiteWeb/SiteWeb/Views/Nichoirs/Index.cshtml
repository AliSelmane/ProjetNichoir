@model List<SiteWeb.Models.nichoirs>

@{
    ViewData["Title"] = "Nichoirs";
    var total = Model?.Count ?? 0;
    var avecEmplacement = Model?.Count(n => !string.IsNullOrWhiteSpace(n.Emplacement)) ?? 0;
    var sansEmplacement = total - avecEmplacement;
}

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .glass {
        background: rgba(255,255,255,.75);
        backdrop-filter: blur(10px);
    }

    .soft-grid {
        background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,.06) 1px, transparent 0);
        background-size: 16px 16px;
    }
</style>

<div class="min-h-screen soft-grid">
    <!-- Header -->
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 pt-10 pb-6">
        <div>
            <div class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-black/5 text-gray-700">
                Dashboard • Projet Nichoir
            </div>

            <h1 class="mt-3 text-3xl sm:text-4xl font-extrabold tracking-tight text-gray-900">
                Nichoirs connectés
            </h1>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
            <div class="glass rounded-3xl border border-white/50 shadow-lg p-5">
                <p class="text-sm font-semibold text-gray-600">Total nichoirs</p>
                <p class="text-3xl font-extrabold text-gray-900">@total</p>
            </div>

            <div class="glass rounded-3xl border border-white/50 shadow-lg p-5">
                <p class="text-sm font-semibold text-gray-600">Avec emplacement</p>
                <p class="text-3xl font-extrabold text-gray-900">@avecEmplacement</p>
            </div>

            <div class="glass rounded-3xl border border-white/50 shadow-lg p-5">
                <p class="text-sm font-semibold text-gray-600">Sans emplacement</p>
                <p class="text-3xl font-extrabold text-gray-900">@sansEmplacement</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 pb-12">
        <div class="rounded-3xl border border-gray-200 bg-white shadow-xl overflow-hidden">

            <!-- Top bar table -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white
                        flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">

                <div class="flex items-center gap-2">
                    <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-gray-900 text-white">
                        <i class="fa-solid fa-list"></i>
                    </span>
                    <div>
                        <p class="font-extrabold text-gray-900">Liste</p>
                        <p id="countLabel" class="text-sm text-gray-600">@total affiché(s)</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">

                    <select id="searchField"
                            class="h-10 rounded-2xl border border-gray-300 bg-white px-3 text-sm text-gray-700
                                   focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Tout</option>
                        <option value="nom">Nom</option>
                        <option value="chip">Chip ID</option>
                        <option value="emp">Emplacement</option>
                    </select>

                    <div class="relative w-64">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </span>

                        <input id="searchInput"
                               type="text"
                               placeholder="Rechercher..."
                               class="w-full h-10 rounded-2xl border border-gray-300 bg-white
                                      py-2 pl-10 pr-9 text-sm
                                      focus:outline-none focus:ring-2 focus:ring-blue-500" />

                        <button id="clearBtn"
                                type="button"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-700">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="p-10 text-center">
                    <h2 class="text-xl font-extrabold">Aucun nichoir</h2>
                </div>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-gray-600">
                                <th class="px-6 py-4 font-extrabold uppercase">Nichoir</th>
                                <th class="px-6 py-4 font-extrabold uppercase">Chip ID</th>
                                <th class="px-6 py-4 font-extrabold uppercase">Emplacement</th>
                                <th class="px-6 py-4 font-extrabold uppercase text-right">Batterie</th>
                            </tr>
                        </thead>

                        <tbody id="rows" class="divide-y divide-gray-100">
                            @foreach (var n in Model)
                            {
                                var emplacement = !string.IsNullOrWhiteSpace(n.Emplacement) ? n.Emplacement : "N/A";

                                <tr class="row hover:bg-gray-50 cursor-pointer"
                                    data-id="@n.Id"
                                    data-nom="@n.Nom"
                                    data-chip="@n.ChipId"
                                    data-emp="@emplacement">

                                    <td class="px-6 py-4 font-bold">@n.Nom</td>
                                    <td class="px-6 py-4">@n.ChipId</td>
                                    <td class="px-6 py-4">@emplacement</td>
                                    <td class="px-6 py-4 text-right">@n.Batterie %</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const searchField = document.getElementById('searchField');
    const clearBtn = document.getElementById('clearBtn');
    const countLabel = document.getElementById('countLabel');

    function rows() {
        return Array.from(document.querySelectorAll('tr.row'));
    }

    function normalize(v) {
        return (v || '').toString().toLowerCase().trim();
    }

    function applyFilter() {
        const q = normalize(searchInput.value);
        const field = searchField.value;
        let visible = 0;

        rows().forEach(r => {
            let value = field === 'all'
                ? `${r.dataset.nom} ${r.dataset.chip} ${r.dataset.emp}`
                : r.dataset[field];

            const ok = normalize(value).includes(q);
            r.style.display = ok ? '' : 'none';
            if (ok) visible++;
        });

        countLabel.textContent = `${visible} affiché(s)`;
    }

    searchInput.addEventListener('input', applyFilter);
    searchField.addEventListener('change', applyFilter);

    clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchField.value = 'all';
        applyFilter();
        searchInput.focus();
    });

    const detailsBaseUrl = '@Url.Action("Details", "Nichoirs")';

    rows().forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.closest('input, select, button, a')) return;
            const id = row.dataset.id;
            if (!id) return;
            window.location.href = detailsBaseUrl + '/' + id;
        });
    });

    applyFilter();
</script>
